{
  "hash": "89241f56ee589d99bdbc675163e6db46",
  "result": {
    "markdown": "---\ntitle: \"Domy Hogwartu - częstość występowania w książkach\"\ndescription: \"Sprawdźmy który dom Hogwartu jest najczęściej wymieniany w serii o Harrym Potterze.\"\nauthor: \"Łukasz Wawrowski\"\ndate: \"01-12-2020\"\nimage: \"domy-hogwartu_files/figure-html/house_percent-1.png\"\n---\n\n\n\n\nDo dziś pamiętam dzień, w którym dostałem do ręki pierwsze książki o przygodach Harrego Pottera. Wiele lat później zainteresowanie serią powróciło, ale tym razem od strony statystycznej. Czy Gryffindor jako dom głównego bohatera jest najczęściej wymienianym domem w książkach sagi? Przekonajmy się.\n\n# Dane\n\nWyszukując w Google frazę \"harry potter txt\" znalazłem wiele stron z tekstową wersją książki. Ostatecznie dane do analizy pobrałem [stąd](http://www.glozman.com/textpages.html). Posługiwanie się angielską wersją książki będzie prostsze z punktu widzenia analizy, ponieważ nie trzeba będzie rozważać wszystkich odmian i przypadków nazwy domu. \n\nW celu wydobycia nazw domów z tekstu wszystkich książek napisałem funkcję, która w całkiem elegancki sposób się tym zajmuje i może także posłużyć w innych analizach tekstu.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidytext)\n\nwords_in_book <- function(book, selected_words){\n  \n  hp <- read_lines(book) # wczytanie tekstu\n  \n  df <- data.frame(org_line=as.character(hp)) %>% \n    filter(str_length(org_line) > 0) %>% # usunięcie pustych wierszy\n    mutate(book_name = book %>% \n             str_replace_all(\"txt/\", \"\") %>% # usunięcie ścieżki z nazwy książki\n             str_replace_all(\".txt\", \"\"), # usunięcie rozszerzenia z nazwy książki\n           line = org_line %>% \n             str_replace_all(\"[^[:alnum:] ]\", \" \")) %>% # usunięcie znaków niealfanumerycznych\n    unnest_tokens(output = words, input = line) # rodzielenie tekstu książki na pojedyńcze wyrazy\n  \n  houses <- df %>% \n    mutate(house=str_match(words, selected_words)) %>% # identyfikacja szukanych słów \n    filter(!is.na(house)) # usunięcie wszystkich pozostałych\n  \n  return(houses)\n  \n}\n```\n:::\n\n\nNastępnie deklaruję jakie pliki chcę przeanalizować oraz jakie słowa mnie interesują. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbooks <- str_c(\"txt/\", list.files(\"txt\"))\n\nhp_houses <- map_df(books, words_in_book, \n                    selected_words = \"gryffindor|hufflepuff|ravenclaw|slytherin\")\n```\n:::\n\n\nWykorzystuję tutaj funkcję `map_df` z pakietu [purrr](https://purrr.tidyverse.org/), który jest wspaniałym narzędziem w sytuacji, w której nie chcemy bawić się w pętle. Pokazany powyżej zapis argumentu `selected_words` powoduje dopasowanie także liczby mnogiej nazwy domu. W rezultacie powstał zbiór zawierający 1206 obserwacji oraz 4 kolumny - z fragmentem książki, tytułem książki, pasującym słowem oraz nazwą domu w Hogwarcie. \n\n# Częstości\n\n\n\n\n\nDokonujemy jeszcze drobnych przekształceń w tekście:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhp_houses <- hp_houses %>% \n  mutate(book=str_replace(book_name, \" - \", \" \\n\"), # tytuł książki w dwóch wierszach\n         house=str_c(str_to_upper(str_sub(house,1,1)), \n                     str_sub(house,2,str_length(house)))) # nazwa domu z wielkiej litery\n```\n:::\n\n\nNastępnie zliczamy wystąpienia danego domu w ramach książki.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhp_houses %>% \n  group_by(book, house) %>% \n  count() %>% \n  ungroup() %>% \n  mutate(book_fct=factor(book, levels = unique(book), ordered = T),\n         house_fct=factor(house, levels = unique(house), ordered = T)) %>% \n  ggplot(aes(x = fct_rev(book_fct), y = n, fill = fct_rev(house))) +\n    geom_col(position = \"dodge\") +\n    geom_text(aes(label = n), position = position_dodge(0.95), hjust = -0.2) +\n    xlab(\"\") +\n    ylab(\"Count\") +\n    ylim(0,130) +\n    scale_fill_manual(values = rev(c(\"#670001\", \"#FF9D0A\", \"#002E5F\", \"#2E751C\")), name = \"\") +\n    coord_flip() +\n    labs(caption = \"Łukasz Wawrowski - wawrowski.edu.pl\") +\n    theme_bw() +\n    theme(legend.position = \"top\", \n          plot.caption = element_text(color = \"grey80\")) +\n    guides(fill = guide_legend(reverse = TRUE)) + \n    ggtitle(\"Occurence of house name in Harry Potter books\")\n```\n\n::: {.cell-output-display}\n![](domy-hogwartu_files/figure-html/house_freq-1.png){width=672}\n:::\n:::\n\n\nWe wszystkich częściach sagi oprócz drugiej (Komnata Tajemnic) zgodnie z oczekiwaniami dominuje Gryffindor. Slytherin zwykle jest na drugim miejscu. Wyjątek stanowi wspomniana część druga (pierwsze miejsce) oraz siódma, gdzie zajmuje trzecie miejsce przegrywając jeszcze z Ravenclawem.\n\nProcentowo wygląda to następująco:\n\n\n::: {.cell preview='true'}\n\n```{.r .cell-code}\nhp_houses %>% \n  group_by(book) %>%\n  count(house) %>% \n  mutate(percent=n/sum(n),\n         percent_label=round_preserve_sum(percent*100)) %>% \n  ungroup() %>% \n  mutate(book_fct=factor(book, levels = unique(book), ordered = T),\n         house_fct=factor(house, levels = unique(house), ordered = T)) %>% \n  ggplot(aes(x = fct_rev(book_fct), y = percent, fill = fct_rev(house))) +\n    geom_col() + \n    geom_text(aes(label = percent_label), position = position_stack(0.5), color = \"white\") +\n    xlab(\"\") +\n    ylab(\"Percentage\") +\n    scale_fill_manual(values = rev(c(\"#670001\", \"#FF9D0A\", \"#002E5F\", \"#2E751C\")), name = \"\") +\n    scale_y_continuous(labels=scales::percent) +\n    coord_flip() +\n    labs(caption = \"Łukasz Wawrowski - wawrowski.edu.pl\") +\n    theme_bw() +\n    theme(legend.position = \"top\", \n          plot.caption = element_text(color = \"grey80\")) +\n    guides(fill = guide_legend(reverse = TRUE)) + \n    ggtitle(\"Occurence of house name in Harry Potter books (in %)\")\n```\n\n::: {.cell-output-display}\n![](domy-hogwartu_files/figure-html/house_percent-1.png){width=672}\n:::\n:::\n\n\nNajwięcej Gryffindoru było w trzeciej części przygód Harrego Pottera, Hufflepuffu w czwartej, Ravenclawu w siódmej, a Slytherinu w drugiej części.\n\nDodatkowo możemy wyznaczyć wskaźnik liczby wzmianek o domach w odniesieniu do liczby stron książki danej części HP. Liczbę stron znalazłem na [tej stronie](https://dustyloft.wordpress.com/2007/07/12/number-of-pages-harry-potter/) i bezpośrednio dodałem do istniejących danych.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npages <- hp_houses %>% \n  distinct(book) %>% \n  mutate(pages=c(223, 251, 317, 636, 766, 607, 607))\n\nhp_houses %>% \n  count(book) %>% \n  inner_join(., pages, by = \"book\") %>% \n  mutate(house_per_page=round(n/pages,2),\n         book_fct=factor(book, levels = unique(book), ordered = T)) %>% \n  ggplot(aes(x = fct_rev(book_fct), y = house_per_page)) +\n    geom_col(fill = \"#FFC001\") +\n    geom_text(aes(label = house_per_page), hjust = -0.2) +\n    coord_flip() +\n    xlab(\"\") +\n    ylab(\"House per page\") +\n    ylim(0,1.05) +\n    labs(caption = \"Łukasz Wawrowski - wawrowski.edu.pl\") +\n    theme_bw() +\n    theme(plot.caption = element_text(color = \"grey80\")) +\n    ggtitle(\"House name mentioned per page in Harry Potter books\")\n```\n\n::: {.cell-output-display}\n![](domy-hogwartu_files/figure-html/house_pages-1.png){width=672}\n:::\n:::\n\n\nW pierwszych dwóch częściach nazwa domu padała prawie raz na stronę. W Więźniu z Azkabanu średnio na co drugiej stronie znajdowało się odwołanie do nazwy domu. Z kolei w ostatnich czterech częściach wartość ta spadła do około 1/4 zapewne ze względu na przeniesienie akcji poza Hogwart.\n\nWszystkie kody są na [githubie](https://github.com/lwawrowski/harrypotter).\n\n\n",
    "supporting": [
      "domy-hogwartu_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}